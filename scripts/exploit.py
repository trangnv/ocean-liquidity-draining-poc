import brownie

from brownie import (
    MockOcean,
    ERC721Template,
    ERC20Template,
    BPool,
    FactoryRouter,
    ERC721Factory,
    SideStaking,
    ZERO_ADDRESS,
)

from scripts.utils import (
    DEPLOYER,
    FEE_COLLECTOR,
    PUBLISHER,
    ATTACKER,
    fromBase18,
    toBase18,
)


def main():
    ocean_token, router = deployment_setup()

    datatoken, pool = pool_setup(
        ocean_token,
        router,
        initial_ocean_liquidity=100_000,
        initial_dt_price=10,
        from_account=PUBLISHER,
    )
    return ocean_token, pool, datatoken


def deployment_setup():
    brownie.chain.reset()

    # DEPLOYER deploys fake OCEAN token
    ocean_token = MockOcean.deploy(DEPLOYER.address, {"from": DEPLOYER})
    ocean_token.transfer(PUBLISHER.address, 1e24, {"from": DEPLOYER})
    ocean_token.transfer(ATTACKER.address, 1e24, {"from": DEPLOYER})

    # DEPLOYER deploys templates
    erc721_template = ERC721Template.deploy({"from": DEPLOYER})
    erc20_template = ERC20Template.deploy({"from": DEPLOYER})
    pool_template = BPool.deploy({"from": DEPLOYER})

    # DEPLOYER deploys Factory Router
    router = FactoryRouter.deploy(
        DEPLOYER.address,
        ocean_token.address,
        pool_template.address,
        FEE_COLLECTOR.address,
        [],
        {"from": DEPLOYER},
    )

    # DEPLOYER deploys ERC721 Factory
    erc721_factory = ERC721Factory.deploy(
        erc721_template.address,
        erc20_template.address,
        router.address,
        {"from": DEPLOYER},
    )
    # DEPLOYER deploys 1-sided staking bot
    ss_bot = SideStaking.deploy(router.address, {"from": DEPLOYER})
    router.addSSContract(ss_bot.address, {"from": DEPLOYER})
    router.addFactory(erc721_factory.address, {"from": DEPLOYER})

    return ocean_token, router


def pool_setup(
    ocean_token, router, initial_ocean_liquidity, initial_dt_price, from_account
):
    # Get contracts addresses from router
    erc721_factory_address = router.factory()
    erc721_factory = ERC721Factory.at(erc721_factory_address)

    ss_bot_address = router.ssContracts(0)
    ss_bot = SideStaking.at(ss_bot_address)

    pool_template_address = router.poolTemplates(0)
    pool_template = BPool.at(pool_template_address)

    # PUBLISHER creates ERC721 data NFT
    tx = erc721_factory.deployERC721Contract(
        "dataNFT",
        "DATANFT",
        1,
        ZERO_ADDRESS,
        ZERO_ADDRESS,
        "https://mystorage.com/mytoken.png",
        True,
        from_account.address,
        {"from": from_account},
    )
    datanft_address = tx.events["NFTCreated"]["newTokenAddress"]
    datanft = ERC721Template.at(datanft_address)

    # PUBLISHER creates ERC20 datatoken
    strings = ["datatoken", "DT"]
    DT_cap = 10000
    uints = [toBase18(DT_cap), toBase18(0.0)]
    addresses = [from_account.address] * 4
    _bytes = []
    tx = datanft.createERC20(
        1, strings, addresses, uints, _bytes, {"from": from_account}
    )

    datatoken_address = tx.events["TokenCreated"]["newTokenAddress"]
    datatoken = ERC20Template.at(datatoken_address)

    # PUBLISHER approves staking OCEAN
    ocean_token.approve(
        router.address, toBase18(initial_ocean_liquidity), {"from": from_account}
    )

    # PUBLISHER deploys pool, which includes a 1-sided staking bot
    ss_params = [
        toBase18(1 / initial_dt_price),  # rate (wei)
        18,  # OCEAN decimals
        toBase18(0.05 * DT_cap),  # vesting amount (wei)
        int(2.5e6),  # vested blocks
        toBase18(initial_ocean_liquidity),
    ]
    swap_fees = [
        toBase18(0.02),  # LP swap fee
        toBase18(0.01),  # mkt swap fee
    ]
    addresses = [
        ss_bot.address,
        ocean_token.address,
        from_account.address,
        from_account.address,
        FEE_COLLECTOR.address,
        pool_template.address,
    ]

    tx = datatoken.deployPool(ss_params, swap_fees, addresses, {"from": from_account})
    pool_address = tx.events["NewPool"]["poolAddress"]
    pool = BPool.at(pool_address)
    return datatoken, pool
